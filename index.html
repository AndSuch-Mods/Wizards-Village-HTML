<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Mage Valley – Prototype Menu Flow</title>
  <style>
    :root {
      color-scheme: dark;
      --bg: radial-gradient(circle at top, #1f2445, #0b0e1d 60%);
      --panel: linear-gradient(145deg, #1c2038, #121525);
      --accent: #9cd164;
      --muted: #b6bedf;
      --outline: rgba(255, 255, 255, 0.08);
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: "Inter", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg);
      color: #e7ecff;
      padding: 32px 18px;
    }

    main {
      width: min(1200px, 100%);
      background: rgba(5, 7, 20, 0.8);
      border: 1px solid var(--outline);
      border-radius: 18px;
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.5);
      padding: 26px;
      display: grid;
      grid-template-columns: 1.1fr 1fr;
      gap: 20px;
    }

    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      border-bottom: 1px solid var(--outline);
      padding-bottom: 10px;
      margin-bottom: 6px;
    }

    h1 {
      letter-spacing: 0.12em;
      font-size: 1.4rem;
    }

    header p {
      color: var(--muted);
      font-size: 0.95rem;
    }

    #screenWrapper {
      grid-column: 1 / -1;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }

    .panel {
      background: var(--panel);
      border-radius: 14px;
      border: 1px solid var(--outline);
      padding: 16px 18px;
      box-shadow: 0 14px 32px rgba(0, 0, 0, 0.35);
      display: flex;
      flex-direction: column;
      gap: 10px;
      min-height: 280px;
    }

    .panel h2 {
      font-size: 1rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      color: #d6ddff;
    }

    .panel p {
      color: var(--muted);
      line-height: 1.5;
    }

    button, input, select {
      font: inherit;
    }

    .btn {
      background: linear-gradient(135deg, #7ac45a, #96d768);
      color: #0e1a0e;
      border: none;
      border-radius: 999px;
      padding: 10px 12px;
      font-weight: 700;
      letter-spacing: 0.04em;
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease, filter 0.1s ease;
      box-shadow: 0 10px 26px rgba(0, 0, 0, 0.35);
    }

    .btn.secondary {
      background: linear-gradient(135deg, #5f7bff, #7f9cff);
      color: #0c1027;
    }

    .btn.ghost {
      background: rgba(255, 255, 255, 0.06);
      color: #e7ecff;
      border: 1px solid var(--outline);
      box-shadow: none;
    }

    .btn:hover {
      transform: translateY(-1px);
      filter: brightness(1.05);
    }

    .btn:active { transform: translateY(0); }

    .screen {
      display: none;
      flex-direction: column;
      gap: 12px;
      height: 100%;
    }

    .screen.active { display: flex; }

    .stack {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .field label {
      display: block;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .field input, .field select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      background: rgba(255, 255, 255, 0.06);
      border: 1px solid var(--outline);
      color: #f7fbff;
    }

    .saveList {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .saveCard {
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--outline);
      background: rgba(255, 255, 255, 0.04);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
    }

    .saveCard strong { color: #e7ecff; }
    .saveCard span { color: var(--muted); font-size: 0.85rem; }

    #preview {
      background: repeating-linear-gradient(45deg, rgba(255,255,255,0.02) 0 12px, rgba(255,255,255,0.05) 12px 24px),
                  radial-gradient(circle at 20% 20%, rgba(156, 209, 100, 0.2), transparent 34%),
                  radial-gradient(circle at 70% 60%, rgba(127, 169, 255, 0.15), transparent 44%),
                  #0f1226;
      border-radius: 14px;
      border: 1px solid var(--outline);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.04);
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 320px;
      color: var(--muted);
      text-align: center;
      padding: 18px;
    }

    .gameLayout {
      display: grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 14px;
      align-items: stretch;
    }

    .mapPanel, .characterPanel {
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--outline);
      border-radius: 12px;
      padding: 14px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mapPanel h3, .characterPanel h3 {
      letter-spacing: 0.08em;
      font-size: 0.95rem;
      color: #d6ddff;
    }

    #mapView {
      flex: 1;
      background: repeating-linear-gradient(
          0deg,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.04) 14px,
          rgba(255, 255, 255, 0.02) 14px,
          rgba(255, 255, 255, 0.02) 28px
        ),
        repeating-linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.03),
          rgba(255, 255, 255, 0.03) 14px,
          rgba(255, 255, 255, 0.01) 14px,
          rgba(255, 255, 255, 0.01) 28px
        ),
        radial-gradient(circle at 30% 40%, rgba(156, 209, 100, 0.16), transparent 40%),
        radial-gradient(circle at 70% 70%, rgba(127, 169, 255, 0.14), transparent 50%),
        #0f1226;
      border-radius: 10px;
      border: 1px solid var(--outline);
      position: relative;
      overflow: hidden;
    }

    #mapView .mapOverlay {
      position: absolute;
      inset: 0;
      display: grid;
      grid-template-columns: repeat(6, 1fr);
      grid-template-rows: repeat(4, 1fr);
      gap: 4px;
      padding: 10px;
    }

    #mapView .tile {
      border: 1px dashed rgba(255,255,255,0.07);
      border-radius: 6px;
      background: rgba(255,255,255,0.02);
    }

    #mapView .mapLabel {
      position: absolute;
      left: 12px;
      bottom: 12px;
      background: rgba(0,0,0,0.5);
      padding: 8px 10px;
      border-radius: 8px;
      border: 1px solid var(--outline);
      color: #d6ddff;
      letter-spacing: 0.06em;
    }

    .characterHeader {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    #characterPreview {
      --hat: #8aa7ff;
      --shirt: #82e0b5;
      --pants: #6d7a9a;
      --robe: #d3b7ff;
      position: relative;
      width: 120px;
      height: 160px;
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--outline);
      border-radius: 12px;
      display: grid;
      place-items: center;
      padding: 8px;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.02);
    }

    .avatar {
      position: relative;
      width: 80px;
      height: 120px;
    }

    .avatar .hat {
      position: absolute;
      top: 0;
      left: 12px;
      width: 56px;
      height: 22px;
      background: var(--hat);
      border-radius: 12px 12px 8px 8px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.35);
    }

    .avatar .head {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 40px;
      height: 34px;
      background: #f0cfa2;
      border-radius: 14px;
      box-shadow: inset 0 -4px 0 rgba(0,0,0,0.08);
    }

    .avatar .robe {
      position: absolute;
      top: 52px;
      left: 10px;
      width: 60px;
      height: 64px;
      background: var(--robe);
      border-radius: 16px 16px 12px 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.15);
    }

    .avatar .shirt {
      position: absolute;
      top: 60px;
      left: 16px;
      width: 48px;
      height: 36px;
      background: var(--shirt);
      border-radius: 12px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.1);
    }

    .avatar .pants {
      position: absolute;
      bottom: 6px;
      left: 18px;
      width: 44px;
      height: 24px;
      background: var(--pants);
      border-radius: 8px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.12);
    }

    .avatar .staff {
      position: absolute;
      right: -4px;
      top: 18px;
      width: 6px;
      height: 94px;
      background: linear-gradient(180deg, #d1ba87, #b08a42);
      border-radius: 4px;
      box-shadow: 0 6px 8px rgba(0,0,0,0.25);
    }

    .avatar .orb {
      position: absolute;
      right: -12px;
      top: 6px;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 30%, #fff, #7cc0ff);
      box-shadow: 0 0 12px rgba(124,192,255,0.8);
    }

    .pieceLabels {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      font-size: 0.8rem;
      color: var(--muted);
      margin-top: 6px;
      text-align: center;
    }

    .tabBar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
    }

    .tabBar button {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--outline);
      border-radius: 10px;
      color: #e7ecff;
      padding: 10px 8px;
      cursor: pointer;
      letter-spacing: 0.04em;
      transition: transform 0.1s ease, border-color 0.1s ease;
    }

    .tabBar button.active {
      border-color: var(--accent);
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
      transform: translateY(-1px);
    }

    .tabContent {
      display: none;
      flex-direction: column;
      gap: 10px;
      padding: 10px;
      border-radius: 10px;
      border: 1px dashed var(--outline);
      background: rgba(255,255,255,0.02);
      min-height: 140px;
    }

    .tabContent.active { display: flex; }

    .inlineFields {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 10px;
    }

    .inventoryList {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 8px;
    }

    .inventoryCard {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--outline);
      background: rgba(255,255,255,0.03);
      display: grid;
      gap: 4px;
    }

    .inventoryCard small { color: var(--muted); }

    .badge {
      display: inline-block;
      background: rgba(156, 209, 100, 0.12);
      color: #c4f08f;
      border: 1px solid rgba(156,209,100,0.3);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 0.75rem;
      letter-spacing: 0.04em;
    }

    .flexBetween { display: flex; justify-content: space-between; align-items: center; gap: 8px; }

    @media (max-width: 1040px) {
      .gameLayout { grid-template-columns: 1fr; }
      .characterHeader { flex-direction: column; align-items: flex-start; }
      #characterPreview { align-self: center; }
    }

    @media (max-width: 860px) {
      main { grid-template-columns: 1fr; }
      #screenWrapper { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <main>
    <header>
      <div>
        <h1>MAGE VALLEY</h1>
        <p>Prototype menu flow — character ➜ zone ➜ placeholder map</p>
      </div>
      <button class="btn ghost" id="backToStart" aria-label="Back to start menu">Back</button>
    </header>

    <section id="screenWrapper">
      <div class="panel">
        <h2>Flow</h2>
        <div id="startScreen" class="screen active" role="group" aria-label="Start screen">
          <p>Begin a new save file or continue an existing journey. Only one screen is visible at a time.</p>
          <div class="stack">
            <button class="btn" id="newCharacter">New Character</button>
            <button class="btn secondary" id="openSaves">Load Save</button>
          </div>
        </div>

        <div id="saveScreen" class="screen" role="group" aria-label="Save selection">
          <p>Select a save to load. Saves are stored in your browser for this prototype.</p>
          <div class="saveList" id="saveList"></div>
          <button class="btn ghost" id="saveBack">Back to Start</button>
        </div>

        <div id="characterScreen" class="screen" role="group" aria-label="Character creation">
          <p>Create your apprentice before entering the valley.</p>
          <div class="field">
            <label for="charName">Name</label>
            <input id="charName" type="text" placeholder="E.g., Liora" />
          </div>
          <div class="field">
            <label for="charFocus">Focus</label>
            <select id="charFocus">
              <option value="Elemental">Elemental</option>
              <option value="Restoration">Restoration</option>
              <option value="Arcane">Arcane</option>
            </select>
          </div>
          <button class="btn" id="createCharacter">Create Character</button>
          <button class="btn ghost" id="characterBack">Back</button>
        </div>

        <div id="zoneScreen" class="screen" role="group" aria-label="Zone selection">
          <p>Choose a starting zone. More locations will appear later.</p>
          <div class="stack">
            <button class="btn" data-zone="Forest" id="startForest">Forest (prototype)</button>
          </div>
          <button class="btn ghost" id="zoneBack">Back</button>
        </div>

        <div id="gameScreen" class="screen" role="group" aria-label="Placeholder game area">
          <p>Loading the zone will display a placeholder map. Use this screen to test layout transitions.</p>
          <div class="gameLayout">
            <div class="mapPanel">
              <div class="flexBetween">
                <h3 id="mapTitle">FOREST</h3>
                <span class="badge" id="zoneBadge">Safe zone</span>
              </div>
              <div id="mapView" aria-label="Zone map preview">
                <div class="mapOverlay" aria-hidden="true"></div>
                <div class="mapLabel">Emerald Approach — prototype map</div>
              </div>
            </div>

            <div class="characterPanel">
              <div class="characterHeader">
                <div>
                  <h3 id="heroName">Apprentice</h3>
                  <p id="heroFocus" style="color: var(--muted)">Focus: Elemental • Zone: Forest</p>
                </div>
                <div id="characterPreview" aria-label="Character preview">
                  <div class="avatar">
                    <div class="hat" aria-hidden="true"></div>
                    <div class="head" aria-hidden="true"></div>
                    <div class="robe" aria-hidden="true"></div>
                    <div class="shirt" aria-hidden="true"></div>
                    <div class="pants" aria-hidden="true"></div>
                    <div class="staff" aria-hidden="true"></div>
                    <div class="orb" aria-hidden="true"></div>
                  </div>
                  <div class="pieceLabels">
                    <span id="hatLabel">Wide Brim</span>
                    <span id="robeLabel">Robe: Twilight</span>
                    <span id="shirtLabel">Tunic: Meadow</span>
                    <span id="pantsLabel">Pants: Midnight</span>
                  </div>
                </div>
              </div>

              <div class="tabBar" id="gameTabs" role="tablist">
                <button data-tab-target="inventory" class="active" role="tab" aria-selected="true">Inventory</button>
                <button data-tab-target="quests" role="tab" aria-selected="false">Quests</button>
                <button data-tab-target="map" role="tab" aria-selected="false">Map</button>
                <button data-tab-target="people" role="tab" aria-selected="false">People</button>
                <button data-tab-target="settings" role="tab" aria-selected="false">Settings</button>
                <button data-tab-target="save" role="tab" aria-selected="false">Save / Exit</button>
              </div>

              <div id="inventory" class="tabContent active" role="tabpanel">
                <p style="color: var(--muted)">Swap hats, shirts, pants, and robes. Choices are saved with your character.</p>
                <div class="inlineFields">
                  <div class="field">
                    <label for="hatStyle">Hat</label>
                    <select id="hatStyle"></select>
                  </div>
                  <div class="field">
                    <label for="hatColor">Hat Color</label>
                    <select id="hatColor"></select>
                  </div>
                  <div class="field">
                    <label for="shirtColor">Shirt Color</label>
                    <select id="shirtColor"></select>
                  </div>
                  <div class="field">
                    <label for="pantsColor">Pants Color</label>
                    <select id="pantsColor"></select>
                  </div>
                  <div class="field">
                    <label for="robeColor">Robe Color</label>
                    <select id="robeColor"></select>
                  </div>
                </div>
                <div class="inventoryList" id="inventoryList"></div>
              </div>

              <div id="quests" class="tabContent" role="tabpanel">
                <h4>Active quests</h4>
                <p style="color: var(--muted)">Prototype hooks only — quests will populate once implemented.</p>
                <ul>
                  <li>Meet the village elder at the hilltop shrine.</li>
                  <li>Gather three sprigs of moonmint.</li>
                </ul>
              </div>

              <div id="map" class="tabContent" role="tabpanel">
                <h4>World map</h4>
                <p style="color: var(--muted)">The grid above represents the current zone. Fast travel and markers will arrive later.</p>
              </div>

              <div id="people" class="tabContent" role="tabpanel">
                <h4>People nearby</h4>
                <p style="color: var(--muted)">No NPCs loaded yet. This tab will list contacts and their relationship states.</p>
              </div>

              <div id="settings" class="tabContent" role="tabpanel">
                <h4>Settings</h4>
                <div class="field">
                  <label for="musicVolume">Music Volume</label>
                  <input id="musicVolume" type="range" min="0" max="100" value="70" />
                </div>
                <div class="field">
                  <label for="uiScale">UI Scale</label>
                  <select id="uiScale">
                    <option>Comfort</option>
                    <option>Cozy</option>
                    <option>Compact</option>
                  </select>
                </div>
              </div>

              <div id="save" class="tabContent" role="tabpanel">
                <p>Save your appearance choices and return to the main menu when ready.</p>
                <div class="stack">
                  <button class="btn secondary" id="saveProgress">Save Progress</button>
                  <button class="btn ghost" id="gameBack">Exit to Start</button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="panel" aria-live="polite">
        <h2>Preview</h2>
        <div id="preview">
          <div id="previewText">Select an option to see the current screen.</div>
        </div>
      </div>
    </section>
  </main>

  <script>
    const screens = {
      start: document.getElementById('startScreen'),
      save: document.getElementById('saveScreen'),
      character: document.getElementById('characterScreen'),
      zone: document.getElementById('zoneScreen'),
      game: document.getElementById('gameScreen'),
    };

    const previewText = document.getElementById('previewText');
    const saveList = document.getElementById('saveList');
    const backButton = document.getElementById('backToStart');
    const mapOverlay = document.querySelector('#mapView .mapOverlay');
    const inventoryList = document.getElementById('inventoryList');
    const gearSelects = {
      hatStyle: document.getElementById('hatStyle'),
      hatColor: document.getElementById('hatColor'),
      shirtColor: document.getElementById('shirtColor'),
      pantsColor: document.getElementById('pantsColor'),
      robeColor: document.getElementById('robeColor'),
    };
    const gearLabels = {
      hat: document.getElementById('hatLabel'),
      shirt: document.getElementById('shirtLabel'),
      pants: document.getElementById('pantsLabel'),
      robe: document.getElementById('robeLabel'),
    };

    const saveKey = 'mageValleyPrototypeSaves';
    let currentCharacter = null;

    const hatStyles = ['Wide Brim', 'Traveler Cap', 'Circlet', 'Hood', 'No Hat'];
    const colorPalette = {
      Twilight: '#d3b7ff',
      Meadow: '#82e0b5',
      Midnight: '#2f3f6b',
      Ember: '#f5a072',
      Dusk: '#7ea5ff',
      Charcoal: '#4c536d',
      Moss: '#6ccf7a',
    };
    const inventoryItems = [
      { name: 'Apprentice Hat', slot: 'Head', notes: 'Swappable brim styles for your mentor look.' },
      { name: 'Layered Tunic', slot: 'Torso', notes: 'Soft linen dyed in travel-safe colors.' },
      { name: 'Spell-scribe Robe', slot: 'Robe', notes: 'Robe panels reinforced for glyph stitching.' },
      { name: 'Traveler Pants', slot: 'Legs', notes: 'Weather-ready trousers with hidden pockets.' },
      { name: 'Birchwood Staff', slot: 'Hand', notes: 'Channeling focus with a skyglass orb.' },
    ];

    function getDefaultAppearance() {
      return {
        hatStyle: hatStyles[0],
        hatColor: 'Dusk',
        shirtColor: 'Meadow',
        pantsColor: 'Midnight',
        robeColor: 'Twilight',
      };
    }

    function ensureAppearance(base) {
      return { ...getDefaultAppearance(), ...(base?.appearance || {}) };
    }

    function setPreview(text) {
      previewText.textContent = text;
    }

    function hideAllScreens() {
      Object.values(screens).forEach((el) => el.classList.remove('active'));
    }

    function showScreen(screenName) {
      hideAllScreens();
      const target = screens[screenName];
      if (target) {
        target.classList.add('active');
      }
      switch (screenName) {
        case 'start':
          setPreview('Start menu — pick New Character or Load Save.');
          break;
        case 'save':
          setPreview('Save list — choose a save slot to load.');
          renderSaves();
          break;
        case 'character':
          setPreview('Character creation — enter a name and focus.');
          break;
        case 'zone':
          const name = currentCharacter?.name || 'your apprentice';
          setPreview(`Zone select — ${name} can begin in the Forest.`);
          break;
        case 'game':
          const zone = currentCharacter?.zone || 'FOREST';
          document.getElementById('mapTitle').textContent = zone.toUpperCase();
          document.getElementById('zoneBadge').textContent = zone === 'Forest' ? 'Safe zone' : 'Zone loaded';
          setPreview('Placeholder game area — map grid and character UI ready.');
          activateTab('inventory');
          hydrateGameUI();
          break;
      }
    }

    function loadSaves() {
      try {
        const raw = localStorage.getItem(saveKey);
        const parsed = raw ? JSON.parse(raw) : [];
        return parsed.map((save) => ({ ...save, appearance: ensureAppearance(save) }));
      } catch (err) {
        console.warn('Unable to load saves', err);
        return [];
      }
    }

    function persistSaves(saves) {
      try {
        localStorage.setItem(saveKey, JSON.stringify(saves));
      } catch (err) {
        console.warn('Unable to save progress', err);
      }
    }

    function renderSaves() {
      const saves = loadSaves();
      saveList.innerHTML = '';
      if (!saves.length) {
        const empty = document.createElement('p');
        empty.textContent = 'No saves yet. Create a character to begin.';
        empty.style.color = 'var(--muted)';
        saveList.appendChild(empty);
        return;
      }

      saves.forEach((save, index) => {
        const card = document.createElement('div');
        card.className = 'saveCard';
        const info = document.createElement('div');
        info.innerHTML = `<strong>${save.name}</strong><br><span>Focus: ${save.focus} • Zone: ${save.zone || 'Forest'}</span>`;
        const btn = document.createElement('button');
        btn.className = 'btn secondary';
        btn.textContent = 'Load';
        btn.addEventListener('click', () => {
          currentCharacter = save;
          showScreen('zone');
        });
        card.append(info, btn);
        saveList.appendChild(card);
      });
    }

    function addSave(save) {
      const saves = loadSaves();
      const completeSave = { ...save, appearance: ensureAppearance(save) };
      saves.unshift(completeSave);
      persistSaves(saves.slice(0, 6));
    }

    function populateMapGrid() {
      if (!mapOverlay) return;
      mapOverlay.innerHTML = '';
      for (let i = 0; i < 24; i += 1) {
        const tile = document.createElement('div');
        tile.className = 'tile';
        mapOverlay.appendChild(tile);
      }
    }

    function populateInventoryList() {
      inventoryList.innerHTML = '';
      inventoryItems.forEach((item) => {
        const card = document.createElement('div');
        card.className = 'inventoryCard';
        card.innerHTML = `<strong>${item.name}</strong><small>${item.slot}</small><p style="color: var(--muted)">${item.notes}</p>`;
        inventoryList.appendChild(card);
      });
    }

    function fillSelectOptions(select, options) {
      select.innerHTML = '';
      options.forEach((opt) => {
        const option = document.createElement('option');
        option.value = opt;
        option.textContent = opt;
        select.appendChild(option);
      });
    }

    function populateGearSelects() {
      fillSelectOptions(gearSelects.hatStyle, hatStyles);
      fillSelectOptions(gearSelects.hatColor, Object.keys(colorPalette));
      fillSelectOptions(gearSelects.shirtColor, Object.keys(colorPalette));
      fillSelectOptions(gearSelects.pantsColor, Object.keys(colorPalette));
      fillSelectOptions(gearSelects.robeColor, Object.keys(colorPalette));
    }

    function applyAppearance(appearance) {
      const preview = document.getElementById('characterPreview');
      preview.style.setProperty('--hat', colorPalette[appearance.hatColor] || colorPalette.Dusk);
      preview.style.setProperty('--shirt', colorPalette[appearance.shirtColor] || colorPalette.Meadow);
      preview.style.setProperty('--pants', colorPalette[appearance.pantsColor] || colorPalette.Midnight);
      preview.style.setProperty('--robe', colorPalette[appearance.robeColor] || colorPalette.Twilight);
      gearLabels.hat.textContent = appearance.hatStyle;
      gearLabels.robe.textContent = `Robe: ${appearance.robeColor}`;
      gearLabels.shirt.textContent = `Tunic: ${appearance.shirtColor}`;
      gearLabels.pants.textContent = `Pants: ${appearance.pantsColor}`;
    }

    function syncGearControls(appearance) {
      gearSelects.hatStyle.value = appearance.hatStyle;
      gearSelects.hatColor.value = appearance.hatColor;
      gearSelects.shirtColor.value = appearance.shirtColor;
      gearSelects.pantsColor.value = appearance.pantsColor;
      gearSelects.robeColor.value = appearance.robeColor;
    }

    function hydrateGameUI() {
      if (!currentCharacter) return;
      currentCharacter.appearance = ensureAppearance(currentCharacter);
      document.getElementById('heroName').textContent = currentCharacter.name;
      document.getElementById('heroFocus').textContent = `Focus: ${currentCharacter.focus} • Zone: ${currentCharacter.zone}`;
      syncGearControls(currentCharacter.appearance);
      applyAppearance(currentCharacter.appearance);
    }

    function handleGearChange() {
      if (!currentCharacter) return;
      currentCharacter.appearance = ensureAppearance(currentCharacter);
      currentCharacter.appearance.hatStyle = gearSelects.hatStyle.value;
      currentCharacter.appearance.hatColor = gearSelects.hatColor.value;
      currentCharacter.appearance.shirtColor = gearSelects.shirtColor.value;
      currentCharacter.appearance.pantsColor = gearSelects.pantsColor.value;
      currentCharacter.appearance.robeColor = gearSelects.robeColor.value;
      applyAppearance(currentCharacter.appearance);
      setPreview('Gear updated — changes will save with your file.');
    }

    function activateTab(targetId) {
      const buttons = document.querySelectorAll('[data-tab-target]');
      const panels = document.querySelectorAll('.tabContent');
      buttons.forEach((btn) => {
        const isActive = btn.dataset.tabTarget === targetId;
        btn.classList.toggle('active', isActive);
        btn.setAttribute('aria-selected', isActive.toString());
      });
      panels.forEach((panel) => {
        panel.classList.toggle('active', panel.id === targetId);
      });
    }

    // Event wiring
    document.getElementById('newCharacter').addEventListener('click', () => {
      currentCharacter = null;
      showScreen('character');
    });

    document.getElementById('openSaves').addEventListener('click', () => {
      showScreen('save');
    });

    document.getElementById('saveBack').addEventListener('click', () => showScreen('start'));
    document.getElementById('characterBack').addEventListener('click', () => showScreen('start'));
    document.getElementById('zoneBack').addEventListener('click', () => showScreen('character'));
    document.getElementById('gameBack').addEventListener('click', () => showScreen('start'));
    backButton.addEventListener('click', () => showScreen('start'));

    document.getElementById('createCharacter').addEventListener('click', () => {
      const name = document.getElementById('charName').value.trim() || 'Apprentice';
      const focus = document.getElementById('charFocus').value;
      currentCharacter = { name, focus, zone: 'Forest', appearance: getDefaultAppearance() };
      addSave(currentCharacter);
      showScreen('zone');
    });

    document.getElementById('startForest').addEventListener('click', () => {
      if (!currentCharacter) {
        currentCharacter = { name: 'Apprentice', focus: 'Elemental', zone: 'Forest', appearance: getDefaultAppearance() };
      }
      currentCharacter.zone = 'Forest';
      currentCharacter.appearance = ensureAppearance(currentCharacter);
      showScreen('game');
    });

    document.getElementById('saveProgress').addEventListener('click', () => {
      if (currentCharacter) addSave(currentCharacter);
      setPreview('Progress saved locally.');
    });

    document.querySelectorAll('[data-tab-target]').forEach((btn) => {
      btn.addEventListener('click', () => activateTab(btn.dataset.tabTarget));
    });

    Object.values(gearSelects).forEach((select) => {
      select.addEventListener('change', handleGearChange);
    });

    // Initialize
    populateMapGrid();
    populateGearSelects();
    populateInventoryList();
    showScreen('start');
  </script>
</body>
</html>
